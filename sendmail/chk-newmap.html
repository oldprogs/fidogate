<HTML>
<HEAD>
<TITLE>
Using a Database in the check_* Rulesets with an Error Message
</TITLE>
<LINK REV="MADE" HREF="mailto:ca@informatik.uni-kiel.de">
<LINK REL="HOME" HREF="../index.html">
<LINK REL="UP" HREF="check.html">
<LINK REL="INDEX" HREF="misc.html">
<META NAME="description" CONTENT="examples to use check_* in sendmail 8.8 with databases and specify and error message in the map">
<META NAME="keywords" CONTENT="e-mail, sendmail, check_, spam, database, map, error, message">
</HEAD>

<BODY>

<H1>
Using a Database in the check_* Rulesets with an Error Message
</H1>

<EM>Last Update 1997-10-03</EM>
<HR>

<H2>
Further Enhanced Version to use a Database in check_mail/check_relay
</H2>

Using a map lookup
has the advantage that you don't need to restart
sendmail
when you change the entries in the database.
Moreover,
if the file gets large
(as it may happen since
<A HREF="spam.html">UCEs</A>
become nearly ubiquitous)
the match should be faster.
This enhanced version uses a common database for
<CODE>
check_mail
</CODE>
and
<CODE>
check_relay
</CODE>.
For the latter, you need
<A HREF="patches/sm_check_relay.p1.html">
a patch
</A>
for
sendmail 8.8.5
to make this work.

<P>
The new version of
<CODE>
check_mail
</CODE>
can also make more rigorous validations of the
supplied
<CODE>
FROM
</CODE>
address.
These rules can be activated by
<CODE>
define(`_CHECK_FROM_',1)
</CODE>
if you use
<CODE>
check_mail3
</CODE>
from the
<A HREF="rules/check.tar">check.tar file</A>.
At least the rule removes an extraneous dot at the
end of the address since this would circumvent the
check for valid domains.


<P>
The database (map) contains entries
for  well-known spammers in the form:
<PRE>
spammer@address.domain "Error-Code Error-Text"
</PRE>
and for junk domains in the form
<PRE>
junk.domain "Error-Code Error-Text"
</PRE>
and for IP numbers which are not allowed to connect
to your mail server:
<PRE>
D.X.Y.Z "Error-Code Error-Text"
C.X.Y "Error-Code Error-Text"
B.X "Error-Code Error-Text"
A "Error-Code Error-Text"
</PRE>
where the lines refer to full IP addresses,
class B, C, or A nets.

<P>
An example for entries in the map is:
<PRE>
natureplus.com "551 This domain is banned."
cyberpromo.com "551 Go away, Spamford."
honey@sweeties.com "551 Honey, you're a spammer, go away."
lamer@aol.com "551 You're a real lamer, go away."
205.199.212	"No access for you, Spamford."
</PRE>

The last entry has no error code,
since 
<CODE>
check_relay
</CODE>
refuses access always with
<CODE>
550 Access denied
</CODE>
and logs the error string.

<P>
The map can be used in
<CODE>
sendmail.cf
</CODE>
as:
<PRE>
Kjunk dbm -a@JUNK /etc/mail/junk
</PRE>
(you may choose another database type and another location).

This is now used in the ruleset as follows:
<PRE>
<A HREF="rules/check_mail3">Scheck_mail</A>
# don't check these
R&lt;$*@$=w&gt;	$@ ok			shortcut
# idea from <A HREF="mailto:sms@wlv.iipo.gtegsc.com">Steven Schultz</A>
R&lt;&gt;		$: &lt;$n @ $(dequote "" $&amp;{client_name} $) &gt;
# mark address
#R$*		$:&lt;@&gt;$1
# is the syntax ok (uses &lt;&gt; and no dot at the end?)
#R&lt;@&gt;&lt;$*@$*$~.&gt;	$:&lt;$1@$2$3&gt;
# mark still there: error...
#R&lt;@&gt;$*		$#error $@ 5.1.8 $: 551 illegal MAIL FROM $1,
# if we don't to the above: remove at least the dot...
R&lt;$*@$*.&gt;	&lt;$1@$2&gt;
R$*		$: $&gt;3 $1			canonify
R$-		$@ ok				local host
# no host without a . in the FQHN ?
# if you get local e-mail from hosts without full domains,
# put a hash in front of the next rule
R$*&lt;@$-&gt;$*	$#error $@ 5.1.8 $: 551 invalid host name $2, check your configuration.
# lookup IP address (reverse mapping available?)
# R$*&lt;@[$-.$-.$-.$-]&gt;$*	$: $1 &lt; @ $[ [ $2.$3.$4.$5 ] $] &gt; $6 
# copy the result of the lookup
R$*		$:$1 $| $1
# now remove the dot
R$* $| $*&lt;@$*.&gt;$*	$: $1 $| $2&lt;@$3&gt;$4
# and check the database
R$* $| $*&lt;@$*&gt;$*	$: $1 $| $&gt;junk $2&lt;@$3&gt;
# match: return given error code (rhs of map)
R$* $| $*&lt;@$*@JUNK&gt;$*	$#error $@ 5.7.1 $: $3
# restore original value (after canonicalization by ruleset 3)
# this is only required if you want to enable the last rule
# R$* $| $*		$: $1
# this is dangerous! no real name
# R$*&lt;@$*$~P&gt;$*	$#error $@ 4.1.8 $: 451 unresolvable host name $2$3, check your setup.

# check for junk domain/spammers
Sjunk
# lookup domain in database
R$*&lt;@$+&gt;		$:$1&lt;@$(junk $2$)&gt;
# exists? return
R$*&lt;@$*@JUNK&gt;		$@$1&lt;@$2@JUNK&gt;
# lookup address in database
R$*&lt;@$+&gt;		$:$1&lt;@$(junk $1@$2 $:$2$)&gt;
# exists? return
R$*&lt;@$*@JUNK&gt;		$@$1&lt;@$2@JUNK&gt;
# remove one subdomain, try again
R$*&lt;@$-.$-.$+&gt;		$: $&gt;junk $1&lt;@$3.$4&gt;
</PRE>

<PRE>
<A HREF="rules/check_relay3">Scheck_relay</A>
# check IP
R$+ $| $+	$: $1 $| $&gt;junkIP $2
R$+ $| $*@JUNK	$#error $@ 5.7.1 $: $2
# check hostname
R$+ $| $+	$: $&gt;junk &lt;@$1&gt;
R$*&lt;@$*@JUNK&gt;$*	$#error $@ 5.7.1 $: $2

SjunkIP
# lookup IP in database
# full IP address
R$-.$-.$-.$-	$: $(junk $1.$2.$3.$4 $)
# class C net
R$-.$-.$-.$-	$: $(junk $1.$2.$3 $: $1.$2.$3.$4 $)
# class B net
R$-.$-.$-.$-	$: $(junk $1.$2 $: $1.$2.$3.$4 $)
# class A net
R$-.$-.$-.$-	$: $(junk $1 $: $1.$2.$3.$4 $)
</PRE>

It is also available as
<CODE>
HACK(check_mail3)
</CODE>
and
<CODE>
HACK(check_relay3)
</CODE>
in the
<A HREF="rules/check.tar">check.tar file</A>
for use in a
<CODE>
.mc
</CODE>
file.

<H3><A NAME="ACCEPT">Accept some Addresses without Checking</A></H3>

The
<CODE>
check_mail2
</CODE>
and
<CODE>
check_mail3
</CODE>
versions in the
<A HREF="rules/check.tar">check.tar file</A>
have a "backdoor" to accept
some addresses without checking them.
This can be activated with:
<PRE>
define(`_ACCEPT_SOME_',1)
</PRE>
Default for the database is:
<PRE>
dbm -o /etc/mail/accept
</PRE>
Other values can be given as argument, e.g.,
<PRE>
define(`_ACCEPT_SOME_',`hash /etc/AcceptIt')
</PRE>
Entries must have the form:
<PRE>
user@address	OK
domain	OK
</PRE>
<HR>
<A HREF="misc.html">[(links)]</A>
<A HREF="english.html">[Hints]</A>
<A HREF="check.html">[Avoiding Spam]</A>
<A HREF="../faqs/sendmailv8.html">[FAQ]</A>
<A HREF="README.cf.8.8.html">[cf/README]</A>
<A HREF="new.html">[New]</A>

<ADDRESS>
Copyright &#169;
<A HREF="../index.html">
Claus A&szlig;mann
</A>
Please send comments to:
<A HREF="mailto:ca@informatik.uni-kiel.de"> &lt;ca@informatik.uni-kiel.de&gt;</A>
</ADDRESS>
</BODY>
</HTML>
