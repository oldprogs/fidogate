/*:ts=8*/
/*****************************************************************************
 * FIDOGATE --- Gateway UNIX Mail/News <-> FIDO NetMail/EchoMail
 *
 * $Id: charset.c,v 4.1 1996/05/11 15:05:36 mj Exp $
 *
 * ^ACHARSET handling stuff as described in FSC-0054
 *
 *****************************************************************************
 * Copyright (C) 1990-1996
 *  _____ _____
 * |	 |___  |   Martin Junius	     FIDO:	2:2452/110
 * | | | |   | |   Republikplatz 3	     Internet:	mj@fido.de
 * |_|_|_|@home|   D-52072 Aachen, Germany
 *
 * This file is part of FIDOGATE.
 *
 * FIDOGATE is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the
 * Free Software Foundation; either version 2, or (at your option) any
 * later version.
 *
 * FIDOGATE is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the GNU
 * General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with FIDOGATE; see the file COPYING.  If not, write to the Free
 * Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
 *****************************************************************************/

#include "fidogate.h"



#define MAXCHARSET	7

#define CHARSET_N	4

#define CHARSET_NONE	0
#define CHARSET_LATIN1	1
#define CHARSET_IBMPC	2
#define CHARSET_MAC	3

#ifdef CHARSET_DEFAULT_IBMPC
/* Default charset ist "IBMPC" */
# define CHARSET_DEFAULT	CHARSET_IBMPC
#else
/* Default charset ist "NONE" */
# define CHARSET_DEFAULT	CHARSET_NONE
#endif


static char *level_2_opt[MAXCHARSET] = {
    "ASCII",	    "LATIN-1",	    "IBMPC",	    "MAC",
    "VT100",	    "PC-8",	    "AMIGA"
};

static int   level_2_chrs[MAXCHARSET] = {
    CHARSET_NONE,   CHARSET_LATIN1, CHARSET_IBMPC,  CHARSET_MAC,
    CHARSET_NONE,   CHARSET_IBMPC,  CHARSET_LATIN1
};

static int charset = CHARSET_DEFAULT;



/*
 * Translation table
 */
static char *xtab[CHARSET_N][128] = {
#ifdef CHARSET_8BIT
/***** Output: ISO-8859-1 8bit chars *****************************************/
{
	/***** Default - common characters ********/
	"\307", "\374", "\351", "\342", "\344", "\340", "\345", "\347", 
	"\352", "\353", "\350", "\357", "\356", "\354", "\304", "\305", 
	"\311", "\346", "\306", "\364", "\366", "\362", "\373", "\371", 
	"\377", "\326", "\334", "\242", "\243", "\245", "Pt", "f",
	"\341", "\355", "\363", "\372", "\361", "\321", "\252", "\272", 
	"\277", "-", "\254", "\275", "\274", "\241", "\253", "\273", 
	"#", "#", "#", "|", "|", "|", "|", "+", 
	"+", "|", "|", "+", "+", "+", "+", "+", 
	"+", "-", "-", "|", "\304", "+", "|", "|", 
	"+", "+", "=", "=", "|", "=", "+", "=", 
	"-", "=", "-", "+", "+", "+", "\326", "|", 
	"+", "+", "+", "#", "\334", "|", "|", "\337", 
	"alpha", "\337", "Gamma", "pi", "\344", "sigma", "\265", "tau", 
	"Phi", "Theta", "Omega", "delta", "infty", "phi", "in", "cap", 
	"==", "\261", ">=", "<=", "integ1", "integ2", "\366", "~=", 
	"\260", ".", "\267", "sqrt", "\374", "\262", "o", " "
},
{
	/***** ISO LATIN-1 ************************/
	"?", "?", "?", "?", "?", "?", "?", "?", 
	"?", "?", "?", "?", "?", "?", "?", "?", 
	"?", "?", "?", "?", "?", "?", "?", "?", 
	"?", "?", "?", "?", "?", "?", "?", "?", 
	"?", "\241", "\242", "\243", "\244", "\245", "\246", "\247", 
	"\250", "\251", "\252", "\253", "\254", "\255", "\256", "\257", 
	"\260", "\261", "\262", "\263", "\264", "\265", "\266", "\267", 
	"\270", "\271", "\272", "\273", "\274", "\275", "\276", "\277", 
	"\300", "\301", "\302", "\303", "\304", "\305", "\306", "\307", 
	"\310", "\311", "\312", "\313", "\314", "\315", "\316", "\317", 
	"\320", "\321", "\322", "\323", "\324", "\325", "\326", "\327", 
	"\330", "\331", "\332", "\333", "\334", "\335", "\336", "\337", 
	"\340", "\341", "\342", "\343", "\344", "\345", "\346", "\347", 
	"\350", "\351", "\352", "\353", "\354", "\355", "\356", "\357", 
	"\360", "\361", "\362", "\363", "\364", "\365", "\366", "\367", 
	"\370", "\371", "\372", "\373", "\374", "\375", "\376", "\377", 
},
{
	/***** IBM PC *****************************/
	"\307", "\374", "\351", "\342", "\344", "\340", "\345", "\347", 
	"\352", "\353", "\350", "\357", "\356", "\354", "\304", "\305", 
	"\311", "\346", "\306", "\364", "\366", "\362", "\373", "\371", 
	"\377", "\326", "\334", "\242", "\243", "\245", "Pt", "f",
	"\341", "\355", "\363", "\372", "\361", "\321", "\252", "\272", 
	"\277", "-", "\254", "\275", "\274", "\241", "\253", "\273", 
	"#", "#", "#", "|", "|", "|", "|", "+", 
	"+", "|", "|", "+", "+", "+", "+", "+", 
	"+", "-", "-", "|", "-", "+", "|", "|", 
	"+", "+", "=", "=", "|", "=", "+", "=", 
	"-", "=", "-", "+", "+", "+", "+", "|", 
	"+", "+", "+", "#", "n", "|", "|", "~", 
	"alpha", "\337", "Gamma", "pi", "Sigma", "sigma", "\265", "tau", 
	"Phi", "Theta", "Omega", "delta", "infty", "phi", "in", "cap", 
	"==", "\261", ">=", "<=", "integ1", "integ2", "\367", "~=", 
	"\260", ".", "\267", "sqrt", "^n", "\262", "o", " "
},
{
	/***** MACINTOSH **************************/
	"\304", "\305", "\307", "\311", "\321", "\326", "\334", "\341", 
	"\340", "\342", "\344", "\343", "\345", "\347", "\351", "\350", 
	"\352", "\353", "\355", "\354", "\356", "\357", "\361", "\363", 
	"\362", "\364", "\366", "\365", "\372", "\371", "\373", "\374", 
	"\276", "\260", "\242", "\243", "\247", "o", "\266", "\337", 
	"\256", "\251", "TM", "\264", "\250", "\255", "\306", "\330", 
	"?", "\261", "\262", "\263", "\245", "\265", "\246", "?", 
	"?", "\271", "\274", "\252", "\272", "\275", "\346", "\370", 
	"\277", "\241", "\254", "?", "f", "~=", "?", "\253", 
	"\273", "..", " ", "\300", "\303", "\325", "OE", "oe", 
	"\320", "-", "\"", "\"", "`", "'", "/", "\327", 
	"\377", "?", "?", "\244", "?", "\335", "\336", "?", 
	"?", "\267", "?", "?", "?", "\302", "\312", "\301", 
	"\313", "\310", "\315", "\316", "\317", "\314", "\323", "\324", 
	"\360", "\322", "\332", "\333", "\331", "?", "?", "?", 
	"\257", "?", "?", "?", "\270", "\375", "\376", "?"
}
#else /**!CHARSET_8BIT**/
/***** Output: ASCII 7bit translations ***************************************/
{
	/***** Default - common characters ********/
	"Ae", "ue", "e", "a", "ae", "Oe", "Ue", "c", 
	"e", "e", "ae", "i", "i", "i", "Ae", "A", 
	"E", "ae", "AE", "o", "oe", "o", "u", "ue", 
	"y", "Oe", "Ue", "c", "#", "Y", "ss", "ss", 
	"a", "i", "o", "u", "n", "N", "a", "o", 
	"?", "-", "!", ".5", "?", "!", "<<", ">>", 
	"#", "#", "#", "|", "|", "|", "|", "+", 
	"+", "|", "|", "+", "+", "+", "+", "+", 
	"+", "-", "-", "|", "Ae", "+", "|", "|", 
	"+", "+", "=", "=", "|", "=", "+", "=", 
	"-", "=", "-", "+", "+", "+", "Oe", "|", 
	"+", "+", "+", "#", "Ue", "|", "|", "ss", 
	"a", "ss", "?", "pi", "ae", "?", "mu", "?", 
	"?", "?", "O", "d", "?", "o", "?", "?", 
	"==", "+-", ">=", "<=", "?", "?", "oe", "~=", 
	"?", ".", "-", "?", "ue", "^2", "o", " "
},
{
	/***** ISO LATIN-1 ************************/
	"?", "?", "?", "?", "?", "?", "?", "?", 
	"?", "?", "?", "?", "?", "?", "?", "?", 
	"?", "?", "?", "?", "?", "?", "?", "?", 
	"?", "?", "?", "?", "?", "?", "?", "?", 
	" ", "!", "c", "#", "?", "Y", "|", "S", 
	"?", "c", "a", "<<", "!", "-", "R", "?", 
	"o", "+-", "^2", "^3", "'", "mu", "?", "o", 
	",", "^1", "o", ">>", "?", ".5", "?", "?", 
	"A", "A", "A", "A", "Ae", "A", "AE", "C", 
	"E", "E", "E", "E", "I", "I", "I", "I", 
	"D", "N", "O", "O", "O", "O", "Oe", "x", 
	"0", "U", "U", "U", "Ue", "Y", "?", "ss", 
	"a", "a", "a", "a", "ae", "a", "ae", "c", 
	"e", "e", "e", "e", "i", "i", "i", "i", 
	"?", "n", "o", "o", "o", "o", "oe", "/", 
	"o", "u", "u", "u", "ue", "y", "?", "y"
},
{
	/***** IBM PC *****************************/
	"C", "ue", "e", "a", "ae", "a", "a", "c", 
	"e", "e", "e", "i", "i", "i", "Ae", "A", 
	"E", "ae", "AE", "o", "oe", "o", "u", "u", 
	"y", "Oe", "Ue", "c", "#", "Y", "Pt", "f", 
	"a", "i", "o", "u", "n", "N", "a", "o", 
	"?", "-", "!", ".5", "?", "!", "<<", ">>", 
	"#", "#", "#", "|", "|", "|", "|", "+", 
	"+", "|", "|", "+", "+", "+", "+", "+", 
	"+", "-", "-", "|", "-", "+", "|", "|", 
	"+", "+", "=", "=", "|", "=", "+", "=", 
	"-", "=", "-", "+", "+", "+", "+", "|", 
	"+", "+", "+", "#", "n", "|", "|", "~", 
	"a", "ss", "?", "pi", "?", "?", "mu", "?", 
	"?", "?", "O", "d", "?", "o", "?", "?", 
	"==", "+-", ">=", "<=", "?", "?", "/", "~=", 
	"?", ".", "-", "?", "^n", "^2", "o", " "
},
{
	/***** MACINTOSH **************************/
	"Ae", "A", "C", "E", "N", "Oe", "Ue", "a", 
	"a", "a", "ae", "a", "a", "c", "e", "e", 
	"e", "e", "i", "i", "i", "i", "n", "o", 
	"o", "o", "oe", "o", "u", "u", "u", "ue", 
	"+", "o", "c", "#", "S", "o", "?", "ss", 
	"R", "c", "TM", "'", "?", "<>", "AE", "0", 
	"?", "+-", "<=", ">=", "Y", "mu", "d", "?", 
	"?", "pi", "?", "a", "o", "O", "ae", "o", 
	"?", "!", "!", "?", "f", "~=", "?", ">>", 
	"<<", "..", " ", "A", "A", "O", "OE", "oe", 
	"-", "-", "\"", "\"", "`", "'", "/", "?", 
	"y", "?", "?", "?", "?", "?", "?", "?", 
	"?", "?", "?", "?", "?", "?", "?", "?", 
	"?", "?", "?", "?", "?", "?", "?", "?", 
	"?", "?", "?", "?", "?", "?", "?", "?", 
	"?", "?", "?", "?", "?", "?", "?", "?"
}
#endif /**CHARSET_8BIT**/
/*****************************************************************************/
};



/*
 * Reset char set
 */
void charset_reset(void)
{
    charset = CHARSET_DEFAULT;
}



/*
 * Set character set from ^ACHARSET kludge line
 */
void charset_set(char *s)
{
    char *name;
    char *p;
    int i=0;
    int level;
    
    while(is_space(*s))
	s++;

    debug(5, "^ACHARSET: %s", s);

    s = strsave(s);
    name  = strtok(s,	 " ");
    if(!name)
	return;
    p	  = strtok(NULL, " ");
    if(!p)
	/*
	 * In this case it's a FSC-0050 kludge without the class code.
	 * Treat it like FSC-0054 level 2.
	 */
	level = 2;
    else
	level = atoi(p);
    
    charset = CHARSET_NONE;
    if(level == 2)
	for(charset=i=0; i<MAXCHARSET; i++)
	    if(!strcmp(name, level_2_opt[i])) {
		charset = level_2_chrs[i];
		break;
	    }
    xfree(s);

    if(charset != CHARSET_NONE)
	debug(5, "charset=%d (%s)", charset, level_2_opt[i]);
}



/*
 * Get translated char
 */
char *charset_xlate(int c)
{
    if(charset>=0 && charset<CHARSET_N)
	return xtab[charset][c & 0x7f];
    else
	return NULL;
}
